var xgminer = require('xgminer');
var async = require('async');
var util = require('util');
//var EventEmitter = require('events').EventEmitter;


// TODO change to event emitter
var client = null;

var getSummary = function(callback) {
	client.summary().then(function (data) {
		callback(null, data['SUMMARY']);
	}, function (err) {
		callback(err,null);
	});
}

var getDevs = function(callback) {
	client.devs().then(function (data) {
		callback(null,data['DEVS']);
	},function (err) {
		callback(err,null);
	});
}

var getPools = function(callback) {
	client.pools().then(function(data) {
		callback(null,data['POOLS']);
	}, function(err) {
		callback(err,null);
	});
}

var getActivePool = function(callback) {
	getPools(function(err, results){
		if(err)
			callback(err, null)
		else {
			var curr = {};
			for (var i = 0, len = results.length; i < len; i++) {
				if(results[i].Priority === 0){
					curr = results[i];
				}
			}
			callback(null, curr);
		}
	});
}

function getStatus (ip, port, cb) {
	client = new xgminer(ip, port);
	async.parallel({
			SUMMARY: getSummary,
			DEVS: getDevs,
			ACTIVE_POOL: getActivePool
	},
	function(err, results) {
		if(err)
			cb(err,null);
		else
			cb(null,results);
	});
}

exports.getStatus = getStatus;
